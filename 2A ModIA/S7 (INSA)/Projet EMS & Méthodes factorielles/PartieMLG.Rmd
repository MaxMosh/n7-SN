---
output:
  pdf_document: default
  html_document: default
---
## Modèle linéaire généralisé

Nous allons dans cette section tenter d'expliquer le dépassement d'émission de méthane de $1000t$ par an en fonction de l'ammoniac, le protoxyde d'azote, le type d'EPCI et l'année par un modèle linéaire généralisé.

```{r, echo=F, eval=F}
#library(bestglm)

# TODO : à remettre en commun

# Ici je refais la sélection des variables (je ne leur applique ni log ni scale)
Data_mlg = read.csv("Data-projetmodIA-2324.csv", header = TRUE)
Data_mlg$code_epci = as.factor(Data_mlg$code_epci)
Data_mlg$lib_epci = as.factor(Data_mlg$lib_epci)
Data_mlg$annee_inv = as.factor(Data_mlg$annee_inv)
Data_mlg$TypeEPCI = as.factor(Data_mlg$TypeEPCI)

# On prend les données quantitatives log
Data_mlg$nh3_kg = log(Data_mlg$nh3_kg)
Data_mlg$n2o_t = log(Data_mlg$n2o_t)

# Je retire les outliers
Data_mlg <- subset(Data_mlg, lib_epci != "Toulouse Métropole") #, "CC Pays de Nay"))
Data_mlg <- subset(Data_mlg, lib_epci != "CC Pays de Nay")

summary(Data_mlg)

# Je garde les variables qui m'intéresse
Data_mlg <- Data_mlg[c(3,10,12,14,15)]

summary(Data_mlg)
```

On crée la nouvelle variable booléenne, valant 1 si le taux de méthane (\code{ch4_t}) est supérieur à $1000t$, 0 sinon.

```{r, echo=T, eval=T}
# Je crée une nouvelle variable qualitative (celle qui traduit méthane > 1000t)
Data_mlg$dep_met_1000 <- as.factor(as.numeric(Data_mlg$ch4_t>1000))

summary(Data_mlg)

# Je retire la variable quantitative ch4_t
Data_mlg <- Data_mlg[c(1,2,4,5,6)]

summary(Data_mlg)
head(Data_mlg)
```

La variable \code{dep_met_1000} étant binaire, nous allons utiliser la régression logistique.

Dans un premier temps on crée le modèle complet avec interaction, modèle que l'on note $(\mathcal{M}_{GL_{1}})$ :

$$
\begin{equation*}
(\text{M}_{GL_{1}}) : 

\begin{cases}
\text{dep_met_1000}_i \sim \mathcal{B}(\pi_\theta(x_i)) \\

\\

\text{logit}[\pi_\theta(x_i)] = \mu  +  \theta_1\cdot\text{nh3_kg}_i  + \theta_2\cdot\text{n2o_t}_i  +  \gamma\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i  \\ 
  + (\beta_1  +  \beta_2\cdot\text{nh3_kg}_i ~ + \beta_3\cdot\text{n2o_t}_i + \beta_4\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i )\mathbb{1}_{\text{TypeEPCI}_i = \text{CC}} \\
  + \sum_{k=1}^5 (\delta_{1k}  +  \delta_{2k}\cdot\text{nh3_kg}_i ~ + \delta_{3k}\cdot\text{n2o_t}_i + \delta_{4k}\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i )\mathbb{1}_{\text{annee}_i = 2014 + k} \\
  + \sum_{k=1}^5 (\kappa_{1k}  +  \kappa_{2k}\cdot\text{nh3_kg}_i ~ + \kappa_{3k}\cdot\text{n2o_t}_i + \kappa_{4k}\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i)\mathbb{1}_{\text{TypeEPCI}_i = \text{CC}}\cdot\mathbb{1}_{\text{annee}_i = 2014 + k} \\

\end{cases}

\end{equation*}
$$

```{r, echo=T, eval=T}
modelcompletinter = glm(dep_met_1000~(.)^2, data=Data_mlg, family=binomial(link = "logit"))
summary(modelcompletinter)
```

On voit que beaucoup de variables ont une pvaleur > 0.05. On va alors s'intéresser à la simplification du modèle.

```{r, echo=T, eval=T}
pseudoR2 = 1 - modelcompletinter$deviance/modelcompletinter$null.deviance
pseudoR2
```

Le $\text{pseudoR}^2$ vaut 0.73, ce qui est une valeur correcte.

```{r, echo = T, eval = F}
# Les bestglm ne fonctionnent pas
#bestglm(Data_mlg,family=binomial,IC="AIC")
#bestglm(Data_mlg,family=binomial,IC="BIC")
```

Ici, les fonctions \code{bestglm} ne fonctionnent pas, nous n'avons donc pas reporté leurs sorties dans le rapport.

```{r, echo = T, eval = T}
# Quelque chose semble ne pas fonctionner dans les step.backward
step.backward = step(modelcompletinter) # AIC
step.backward = step(modelcompletinter, direction="backward",k=log(nrow(Data_mlg))) # BIC
```

Le critère $AIC$ conserve le modèle sans l'interaction annee_inv:TypeEPCI, modèle que l'on note $(\text{M}_{GL_{2}})$.
Le critère $BIC$ conserve le modèle avec les variables nh3_kg, n2o_t, TypeEPCI, nh3_kg:n2o_t, modèle que l'on note $(\text{M}_{GL_{3}})$.


$$
\begin{equation*}
(\text{M}_{GL_{2}}) : 

\begin{cases}
\text{dep_met_1000}_i \sim \mathcal{B}(\pi_\theta(x_i)) \\

\\

\text{logit}[\pi_\theta(x_i)] = \mu  +  \theta_1\cdot\text{nh3_kg}_i  + \theta_2\cdot\text{n2o_t}_i  +  \gamma\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i  \\ 
  + (\beta_1  +  \beta_2\cdot\text{nh3_kg}_i ~ + \beta_3\cdot\text{n2o_t}_i  + \beta_4\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i )\mathbb{1}_{\text{TypeEPCI}_i = \text{CC}} \\
  + \sum_{k=1}^5 (\delta_{1k}  +  \delta_{2k}\cdot\text{nh3_kg}_i ~ + \delta_{3k}\cdot\text{n2o_t}_i + \delta_{4k}\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i )\mathbb{1}_{\text{annee}_i = 2014 + k} \\

\end{cases}

\end{equation*}
$$


$$
\begin{equation*}
(\text{M}_{GL_{3}}) : 

\begin{cases}
\text{dep_met_1000}_i \sim \mathcal{B}(\pi_\theta(x_i)) \\

\\

\text{logit}[\pi_\theta(x_i)] = \mu  +  \theta_1\cdot\text{nh3_kg}_i  + \theta_2\cdot\text{n2o_t}_i  +  \gamma\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i  \\ 
  + (\beta_1  +  \beta_2\cdot\text{nh3_kg}_i ~ + \beta_3\cdot\text{n2o_t}_i + \beta_4\cdot\text{nh3_kg}_i\cdot\text{n2o_t}_i )\mathbb{1}_{\text{TypeEPCI}_i = \text{CC}} \\

\end{cases}

\end{equation*}

$$  


```{r, echo = T, eval = T}
# Modèle 2
model2 = glm(dep_met_1000~annee_inv + nh3_kg + n2o_t + TypeEPCI + annee_inv:nh3_kg + 
    annee_inv:n2o_t + nh3_kg:n2o_t + nh3_kg:TypeEPCI + n2o_t:TypeEPCI ,data=Data_mlg, family=binomial(link = "logit"))
summary(model2)
```

On teste le sous-modèle $(\text{M}_{GL_{2}})$ par rapport au modèle complet avec interactions $(\text{M}_{GL_{1}})$.

```{r, echo = T, eval = T}
anova(model2, modelcompletinter, test="Chisq")
```

La pvaleur est >>0.05, on peut donc conserver le modèle $(\text{M}_{GL_{2}})$ au risque 5%.

```{r, echo = T, eval = T}
pseudoR2 = 1 - modelinterred$deviance/modelinterred$null.deviance
pseudoR2
```

Le $\text{pseudoR}^2$ vaut 0.72, ce qui reste une valeur correcte (très légèrement en dessous du $\text{pseudoR}^2$ du modèle complet avec interaction).

```{r, echo = T, eval = T}
# Modèle 3
model3 = glm(dep_met_1000 ~ nh3_kg + n2o_t + TypeEPCI + nh3_kg:n2o_t,data=Data_mlg, family=binomial(link = "logit"))
summary(model3)
```

```{r, echo = T, eval = T}
anova(model3, modelcompletinter, test="Chisq")
```

Cependant, le test du sous-modèle $(\text{M}_{GL_{3}})$ vis-à-vis du modèle complet $(\text{M}_{GL_{1}})$ renvoie une pvaleur << 0.05.
On rejette donc le modèle $(\text{M}_{GL_{3}})$ au risque $5\%$.